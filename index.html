<!DOCTYPE html> 
<html lang="pt"> 
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Localização</title>
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        body { 
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            width: 100%;
            /* Imagem de fundo (Mapa estilizado) */
            background-color: #4a5568;
            background-size: a  uto;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        } 

        .container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            margin-left: 8%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            backdrop-filter: blur(5px);
        }

        h1 { 
            margin: 0;
            color: #1a202c;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        } 

        p {
            color: #4a5568;
            font-size: 15px;
            line-height: 1.5;
            margin: 0 0 10px 0;
        }

        input { 
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            outline: none;
        } 

        input:focus {
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        button { 
            width: 100%;
            padding: 14px;
            background-color: #3182ce;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px; /* Espaço entre o spinner e o texto */
        } 

        button:hover:not(:disabled) { 
            background-color: #2c5282;
            transform: translateY(-1px);
        } 

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Estilo quando o botão está bloqueado/carregando */
        button:disabled {
            background-color: #63b3ed;
            cursor: not-allowed;
            opacity: 0.8;
        }

        #status { 
            margin-top: 10px;
            font-size: 14px;
            color: #718096;
            background: #f7fafc;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #cbd5e0;
        } 

        /* CSS DA ANIMAÇÃO (SPINNER) */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            display: none; /* Escondido por padrão */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .container {
                margin: 20px;
                max-width: 100%;
            }
        }
    </style> 
</head> 
<body> 
    
    <div class="container">
        <h1>Enviar Localização</h1> 
        <p>Insira o email e pressione o botão para enviar os dados (email e localização).</p> 
        <input type="email" id="email" placeholder="Insira email" required> 
        <button id="btnSend" onclick="getLocation()">
            <span id="spinner" class="spinner"></span>
            <span id="btnText">Enviar Localização</span>
        </button> 
        <p id="status">Clique no botão para enviar dados.</p> 
    </div>

    <script> 
        const targetLatitude = 40.730610; 
        const targetLongitude = -73.935242; 
        const makeWebhookURL = "https://hook.eu1.make.com/j052hztsjuj6xr19usouyodtp3jhliuw"; 

        // --- Funções Auxiliares de UI ---
        function setLoadingState(isLoading) {
            const btn = document.getElementById("btnSend");
            const spinner = document.getElementById("spinner");
            const btnText = document.getElementById("btnText");

            if (isLoading) {
                btn.disabled = true;
                spinner.style.display = "block";
                btnText.innerText = "A enviar...";
            } else {
                btn.disabled = false;
                spinner.style.display = "none";
                btnText.innerText = "Enviar Localização";
            }
        }

        function getLocation() { 
            const email = document.getElementById("email").value; 
 
            if (!email) { 
                document.getElementById("status").innerHTML = "Por favor, insira um email válido."; 
                return; 
            } 
 
            if (navigator.geolocation) { 
                setLoadingState(true); // Ativa o spinner
                document.getElementById("status").innerHTML = "A obter localização...";
                
                navigator.geolocation.getCurrentPosition( 
                    (position) => calculateDistanceAndSend(position, email), 
                    (error) => {
                        showError(error);
                        setLoadingState(false); // Desativa spinner se falhar geolocalização
                    }
                ); 
            } else { 
                document.getElementById("status").innerHTML = "A Geolocalização não é suportada pelo navegador."; 
            } 
        } 
 
        function calculateDistanceAndSend(position, email) { 
            const userLatitude = position.coords.latitude; 
            const userLongitude = position.coords.longitude; 
 
            const distance = calculateDistance(userLatitude, userLongitude, targetLatitude, targetLongitude); 
 
            document.getElementById("status").innerHTML = `Distância calculada: ${distance.toFixed(2)} km. Enviando dados...`; 
 
            const data = { 
                email: email, 
                distance: distance.toFixed(2), 
                timestamp: new Date().toLocaleString() 
            }; 
 
            fetch(makeWebhookURL, { 
                method: "POST", 
                headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify(data) 
            }).then(response => { 
                setLoadingState(false); // Desativa spinner
                if (response.ok) { 
                    document.getElementById("status").innerHTML = "Dados enviados com sucesso! Aguarde o email."; 
                    document.getElementById("status").style.borderLeftColor = "#48bb78";
                } else { 
                    document.getElementById("status").innerHTML = "Erro ao enviar os dados."; 
                    document.getElementById("status").style.borderLeftColor = "#f56565";
                } 
            }).catch(error => { 
                setLoadingState(false); // Desativa spinner no erro de rede
                document.getElementById("status").innerHTML = "Erro na ligação com o Make: " + error.message; 
                document.getElementById("status").style.borderLeftColor = "#f56565";
            }); 
        } 
 
        function calculateDistance(lat1, lon1, lat2, lon2) { 
            const R = 6371; 
            const φ1 = lat1 * Math.PI / 180; 
            const φ2 = lat2 * Math.PI / 180; 
            const Δφ = (lat2 - lat1) * Math.PI / 180; 
            const Δλ = (lon2 - lon1) * Math.PI / 180; 
 
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + 
                      Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
            return R * c; 
        } 
 
        function showError(error) { 
            const statusDiv = document.getElementById("status");
            statusDiv.style.borderLeftColor = "#f56565";

            switch (error.code) { 
                case error.PERMISSION_DENIED: 
                    statusDiv.innerHTML = "O Utilizador negou a solicitação de geolocalização."; 
                    break; 
                case error.POSITION_UNAVAILABLE: 
                    statusDiv.innerHTML = "Informações de localização não estão disponíveis."; 
                    break; 
                case error.TIMEOUT: 
                    statusDiv.innerHTML = "A solicitação expirou."; 
                    break; 
                case error.UNKNOWN_ERROR: 
                    statusDiv.innerHTML = "Ocorreu um erro desconhecido."; 
                    break; 
            } 
        } 
    </script> 
</body> 
</html>